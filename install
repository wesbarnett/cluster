#!/bin/bash
# Arch install script for cluster node

GITHUB=https://raw.githubusercontent.com/wesbarnett/cluster/master
PART2=install-part2

echo "Which type of machine are you installing on?"
select TYPE in master node; do
	if [[ "$REPLY"  = 1 ]]; then
		BOOT=200M
		ROOT=40G
		break
	elif [[ "$REPLY" = 2 ]]; then
		BOOT=200M
		ROOT=20G
		break
	fi
done

# TODO: in future use RAID-5 with 3 disks
# or could possibly use LVM to make this more seamless

# Partition the disks
echo "Partitioning /dev/sda..."
sgdisk -og /dev/sda 
sgdisk -n 1:2048:+$BOOT -c 1:"Linux /boot" -t 1:8300 /dev/sda
sgdisk -n 2:+0M:+$ROOT -c 2:"Linux /" -t 2:8300 /dev/sda
sgdisk -n 3 -c 3:"Linux /home" -t 3:8300 /dev/sda
sgdisk -n 4 -c 4:"BIOS boot partition" -t 4:ef02 /dev/sda

# Extra disk
echo "Partitioning /dev/sdb..."
sgdisk -og /dev/sdb
sgdisk -n 1 -c 1:"Linux /data" -t 1:8300 /dev/sdb

# Format the partitions
echo "Creating filesystems..."
mkfs.ext4 /dev/sda1
mkfs.ext4 /dev/sda2
mkfs.ext4 /dev/sda3
mkfs.ext4 /dev/sdb1

# Mount the partitions (mount root first)
echo "Mounting partitions..."
mount /dev/sda2 /mnt
mkdir -p /mnt/boot
mount /dev/sda1 /mnt/boot
mkdir -p /mnt/home
mount /dev/sda3 /mnt/home
mkdir -p /mnt/data
mount /dev/sdb1 /mnt/data

# Install base system
echo "Installing base system..."
pacstrap /mnt base base-devel

# Make sure disks are automounted
echo "Generating fstab..."
genfstab -U -p /mnt >> /mnt/etc/fstab

echo "Getting part 2..."
wget $GITHUB/$PART2
chmod +x $PART2
cp $PART2 /mnt/

echo "You are now entering chroot environment. Run ./$PART2 to continue"
# Base system is installed, now change to it and run postinstall script there
arch-chroot /mnt /bin/bash
